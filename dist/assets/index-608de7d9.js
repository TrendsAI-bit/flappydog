import{A as w}from"./audio-1a7b1538.js";import{U as v}from"./ui-de6bd2fa.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function e(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(s){if(s.ep)return;s.ep=!0;const a=e(s);fetch(s.href,a)}})();class M{constructor(){this.apiEndpoint="",this.sessionId="",this.playerName="",this.countryFlag="🌍",this.localScores=[],this.dailyChallenges=new Map,this.sessionNonce="",this.secretKey="",this.recordingGhost=!1,this.currentGhostData=null,this.recordingStartTime=0,this.leaderboardCache=new Map,this.cacheExpiry=5*60*1e3,this.initializeSession(),this.detectUserLocation(),this.loadLocalData()}async initialize(){try{this.apiEndpoint=this.getApiEndpoint(),await this.initializeSession(),await this.loadTodaysChallenge(),console.log("Leaderboard system initialized")}catch(t){console.warn("Leaderboard initialization failed, using offline mode:",t)}}getApiEndpoint(){return"/api"}async initializeSession(){try{this.sessionId=this.generateSessionId(),this.playerName=localStorage.getItem("flappydog-playername")||this.generatePlayerName();const t=await fetch(`${this.apiEndpoint}/session`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionId:this.sessionId})});if(t.ok){const e=await t.json();this.sessionNonce=e.nonce,this.secretKey=e.key}}catch(t){console.warn("Failed to initialize server session, using offline mode:",t),this.sessionNonce=this.generateNonce()}}detectUserLocation(){try{const t=Intl.DateTimeFormat().resolvedOptions().timeZone;this.countryFlag=this.getCountryFlagFromTimezone(t)}catch(t){this.countryFlag="🌍"}}getCountryFlagFromTimezone(t){return{"America/New_York":"🇺🇸","America/Los_Angeles":"🇺🇸","America/Chicago":"🇺🇸","Europe/London":"🇬🇧","Europe/Paris":"🇫🇷","Europe/Berlin":"🇩🇪","Asia/Tokyo":"🇯🇵","Asia/Shanghai":"🇨🇳","Asia/Seoul":"🇰🇷","Australia/Sydney":"🇦🇺","America/Toronto":"🇨🇦","America/Mexico_City":"🇲🇽","America/Sao_Paulo":"🇧🇷","Europe/Rome":"🇮🇹","Europe/Madrid":"🇪🇸","Asia/Mumbai":"🇮🇳","Asia/Singapore":"🇸🇬"}[t]||"🌍"}loadLocalData(){const t=localStorage.getItem("flappydog-local-scores");t&&(this.localScores=JSON.parse(t));const e=localStorage.getItem("flappydog-daily-challenges");e&&JSON.parse(e).forEach(s=>{this.dailyChallenges.set(s.date,s)})}saveLocalData(){localStorage.setItem("flappydog-local-scores",JSON.stringify(this.localScores));const t=Array.from(this.dailyChallenges.values());localStorage.setItem("flappydog-daily-challenges",JSON.stringify(t))}startGhostRecording(){this.recordingGhost=!0,this.recordingStartTime=Date.now(),this.currentGhostData={positions:[],events:[],duration:0,checksum:""}}recordGhostPosition(t,e,i){if(!this.recordingGhost||!this.currentGhostData)return;const s=Date.now()-this.recordingStartTime;(this.currentGhostData.positions.length===0||s-this.currentGhostData.positions[this.currentGhostData.positions.length-1].time>=33)&&this.currentGhostData.positions.push({time:s,x:t,y:e,rotation:i})}recordGhostEvent(t,e){if(!this.recordingGhost||!this.currentGhostData)return;const i=Date.now()-this.recordingStartTime;this.currentGhostData.events.push({time:i,type:t,data:e})}stopGhostRecording(){if(!this.recordingGhost||!this.currentGhostData)return null;this.recordingGhost=!1,this.currentGhostData.duration=Date.now()-this.recordingStartTime,this.currentGhostData.checksum=this.generateGhostChecksum(this.currentGhostData);const t=this.currentGhostData;return this.currentGhostData=null,t}generateGhostChecksum(t){const e=JSON.stringify({positionCount:t.positions.length,eventCount:t.events.length,duration:t.duration,firstPosition:t.positions[0],lastPosition:t.positions[t.positions.length-1]});return this.simpleHash(e)}async submitScore(t,e,i,s="classic"){try{const a=this.analyzeGhostData(i);if(!this.validateScore(t,a))return console.warn("Score failed anti-cheat validation"),!1;const r={id:this.generateEntryId(),playerName:this.playerName,score:t,timestamp:Date.now(),seed:e,flag:this.countryFlag,gameMode:s,verified:!0,ghostData:i};return this.addLocalScore(r),await this.submitToServer(r)&&(this.leaderboardCache.clear(),console.log("Score submitted successfully")),!0}catch(a){return console.warn("Score submission failed:",a),!1}}async submitToServer(t){if(!this.apiEndpoint)return!1;try{const e={score:t.score,seed:t.seed,gameMode:t.gameMode,ghostData:t.ghostData,playerName:t.playerName,timestamp:t.timestamp,sessionId:this.sessionId,signature:this.signSubmission(t)},i=await fetch(`${this.apiEndpoint}/submit-score`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(i.ok)return(await i.json()).success;{const s=await i.text();return console.warn("Server rejected score submission:",s),!1}}catch(e){return console.warn("Network error during score submission:",e),!1}}signSubmission(t){const e=`${t.score}:${t.seed}:${t.timestamp}:${this.sessionNonce}`;return this.simpleHash(e+this.secretKey)}addLocalScore(t){this.localScores.push(t),this.localScores.sort((e,i)=>i.score-e.score),this.localScores=this.localScores.slice(0,100),this.saveLocalData()}analyzeGhostData(t){let e=0,i=0,s=0;const a=t.events.filter(o=>o.type==="flap");if(a.length>1){const o=[];for(let l=1;l<a.length;l++)o.push(a[l].time-a[l-1].time);o.sort((l,c)=>l-c),e=o.length>0?1e3/o[0]:0}for(let o=1;o<t.positions.length;o++){const l=t.positions[o-1],c=t.positions[o],p=c.time-l.time,x=Math.sqrt(Math.pow(c.x-l.x,2)+Math.pow(c.y-l.y,2)),S=1e3;p>0&&x/(p/1e3)>S&&i++,(c.x<-100||c.x>900||c.y<-100||c.y>700)&&i++}for(let o=1;o<t.positions.length;o++)t.positions[o].time<=t.positions[o-1].time&&s++;const r=t.events.filter(o=>o.type==="score").length,g=Math.abs(r-Math.floor(r))<.1?1:0;return{maxFlapRate:e,impossiblePositions:i,timeInconsistencies:s,scoreConsistency:g}}validateScore(t,e){return!(e.maxFlapRate>20||e.impossiblePositions>5||e.timeInconsistencies>10||t<0||t>1e4)}async getLeaderboard(t,e=50){const i=`${t}-${e}`,s=this.leaderboardCache.get(i);if(s&&Date.now()-s.timestamp<this.cacheExpiry)return s.data;try{const a=await this.fetchFromServer(t,e);if(a.length>0)return this.leaderboardCache.set(i,{data:a,timestamp:Date.now()}),a}catch(a){console.warn("Failed to fetch leaderboard from server:",a)}return this.getLocalLeaderboard(t,e)}async fetchFromServer(t,e){if(!this.apiEndpoint)return[];const i=await fetch(`${this.apiEndpoint}/leaderboard?type=${t}&limit=${e}`);return i.ok?(await i.json()).entries||[]:[]}getLocalLeaderboard(t,e){let i=[...this.localScores];if(t==="daily"){const s=this.getTodayString(),a=this.dailyChallenges.get(s);a?i=i.filter(r=>r.seed===a.seed):i=[]}return i.slice(0,e)}async loadTodaysChallenge(){const t=this.getTodayString();if(this.dailyChallenges.has(t))return;try{const i=await fetch(`${this.apiEndpoint}/daily-challenge?date=${t}`);if(i.ok){const s=await i.json();this.dailyChallenges.set(t,s),this.saveLocalData();return}}catch(i){console.warn("Failed to load daily challenge from server:",i)}const e={date:t,seed:this.generateDailySeed(t),leaderboard:[],playerBest:null,ghostRace:null};this.dailyChallenges.set(t,e),this.saveLocalData()}getDailyChallenge(){const t=this.getTodayString();return this.dailyChallenges.get(t)||null}async getGhostRace(t){try{const s=await fetch(`${this.apiEndpoint}/ghost-race?seed=${t}`);if(s.ok)return(await s.json()).ghost}catch(s){console.warn("Failed to load ghost race:",s)}const e=this.getTodayString(),i=this.dailyChallenges.get(e);return(i==null?void 0:i.ghostRace)||null}createGhostPlayer(t){return new b(t)}generateSessionId(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}generatePlayerName(){const t=["Swift","Brave","Clever","Quick","Happy","Lucky","Mighty","Noble"],e=["Dog","Wolf","Fox","Eagle","Hawk","Lion","Tiger","Bear"],i=t[Math.floor(Math.random()*t.length)],s=e[Math.floor(Math.random()*e.length)],a=Math.floor(Math.random()*1e3);return`${i}${s}${a}`}generateEntryId(){return Date.now().toString(36)+Math.random().toString(36).substr(2,9)}generateNonce(){return Math.random().toString(36).substr(2,15)}generateDailySeed(t){return this.simpleHash(t+"flappydog-daily").substr(0,8)}getTodayString(){const t=new Date;return`${t.getFullYear()}-${(t.getMonth()+1).toString().padStart(2,"0")}-${t.getDate().toString().padStart(2,"0")}`}simpleHash(t){let e=0;for(let i=0;i<t.length;i++){const s=t.charCodeAt(i);e=(e<<5)-e+s,e=e&e}return Math.abs(e).toString(36)}setPlayerName(t){this.playerName=t,localStorage.setItem("flappydog-playername",t)}getPlayerName(){return this.playerName}getLocalBestScore(){return this.localScores.length>0?this.localScores[0].score:0}clearLocalData(){this.localScores=[],this.dailyChallenges.clear(),this.leaderboardCache.clear(),localStorage.removeItem("flappydog-local-scores"),localStorage.removeItem("flappydog-daily-challenges")}}class b{constructor(t){this.startTime=0,this.playing=!1,this.currentPositionIndex=0,this.currentEventIndex=0,this.ghostData=t}start(){this.startTime=Date.now(),this.playing=!0,this.currentPositionIndex=0,this.currentEventIndex=0}stop(){this.playing=!1}isPlaying(){return this.playing}getCurrentPosition(){if(!this.playing)return null;const t=Date.now()-this.startTime;for(;this.currentPositionIndex<this.ghostData.positions.length-1&&!(this.ghostData.positions[this.currentPositionIndex+1].time>t);)this.currentPositionIndex++;if(this.currentPositionIndex>=this.ghostData.positions.length)return this.playing=!1,null;const e=this.ghostData.positions[this.currentPositionIndex],i=this.ghostData.positions[this.currentPositionIndex+1];if(i){const s=(t-e.time)/(i.time-e.time),a=Math.max(0,Math.min(1,s));return{x:e.x+(i.x-e.x)*a,y:e.y+(i.y-e.y)*a,rotation:e.rotation+(i.rotation-e.rotation)*a}}return{x:e.x,y:e.y,rotation:e.rotation}}getNextEvent(){if(!this.playing)return null;const t=Date.now()-this.startTime;if(this.currentEventIndex<this.ghostData.events.length){const e=this.ghostData.events[this.currentEventIndex];if(e.time<=t)return this.currentEventIndex++,{type:e.type,data:e.data}}return null}getProgress(){if(!this.playing)return 0;const t=Date.now()-this.startTime;return Math.min(1,t/this.ghostData.duration)}}const n=800,h=600,u=.6,f=-12,F=.3,D=8,m=8e3,y=.15;class P{constructor(){this.lastTime=0,this.deltaTime=0,this.gameState="menu",this.gameMode="classic",this.obstacles=[],this.collectibles=[],this.particles=[],this.score=0,this.bestScore=0,this.superWagMeter=0,this.dashCooldown=0,this.wind=null,this.perfectBeatStreak=0,this.bulletTimeRemaining=0,this.keys=new Set,this.mousePressed=!1,this.touchPressed=!1,this.lastTapTime=0,this.doubleTapWindow=300,this.sprites=new Map,this.spritesLoaded=0,this.totalSprites=0,this.settings={soundVolume:.7,musicVolume:.5,haptics:!0,colorblind:!1,highContrast:!1,leftHandMode:!1,motionReduced:!1,screenShake:!0,rhythmAssist:!0},this.recentFailures=0,this.difficultyMultiplier=1,this.dailySeed="",this.ghostData=[],this.recordingGhost=!1,this._activeQuests=[],this._completedCosmetics=new Set,this.frameCount=0,this.fps=60,this._targetFps=60,this.gameLoop=(t=0)=>{this.deltaTime=t-this.lastTime,this.lastTime=t,this.deltaTime=Math.min(this.deltaTime,50),this.frameCount++,this.frameCount%60===0&&(this.fps=Math.round(1e3/(this.deltaTime||16.67))),this.update(this.deltaTime),this.render(),requestAnimationFrame(this.gameLoop)},this.canvas=document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),this.audioManager=new w,this.uiManager=new v,this.leaderboardManager=new M,this.dog=this.createDog(),this.setupCanvas(),this.loadSettings(),this.setupEventListeners(),this.generateDailySeed(),this.initializeQuests(),this.loadAssets()}setupCanvas(){this.canvas.width=n,this.canvas.height=h;const t=window.devicePixelRatio||1,e=this.canvas.getBoundingClientRect();this.canvas.width=e.width*t,this.canvas.height=e.height*t,this.ctx.scale(t,t),this.canvas.style.width="100vw",this.canvas.style.height="100vh",this.canvas.style.display="block",this.canvas.style.imageRendering="pixelated"}createDog(){return{position:{x:n*.2,y:h*.5},velocity:{x:0,y:0},width:48,height:32,active:!0,rotation:0,flapAnimation:0,blinkTimer:0,invulnerable:!1,superWagActive:!1}}setupEventListeners(){window.addEventListener("keydown",t=>{this.keys.add(t.code),this.handleInput(t.code)}),window.addEventListener("keyup",t=>{this.keys.delete(t.code)}),this.canvas.addEventListener("mousedown",t=>{t.preventDefault(),this.mousePressed=!0,this.handleInput("mouse")}),window.addEventListener("mouseup",()=>{this.mousePressed=!1}),this.canvas.addEventListener("touchstart",t=>{t.preventDefault(),this.touchPressed=!0;const e=Date.now();e-this.lastTapTime<this.doubleTapWindow&&this.handleDoubleTap(),this.lastTapTime=e,this.handleInput("touch")}),this.canvas.addEventListener("touchend",t=>{t.preventDefault(),this.touchPressed=!1}),this.canvas.addEventListener("contextmenu",t=>{t.preventDefault()}),document.addEventListener("visibilitychange",()=>{document.hidden?(this._targetFps=30,this.gameState==="playing"&&(this.gameState="paused")):this._targetFps=60})}handleInput(t){if(this.gameState==="menu"){this.startGame();return}this.gameState==="playing"&&((t==="Space"||t==="ArrowUp"||t==="mouse"||t==="touch")&&this.flap(),t==="Escape"&&this.pauseGame()),this.gameState==="paused"&&(t==="Space"||t==="mouse"||t==="touch")&&this.resumeGame(),this.gameState==="gameover"&&(t==="Space"||t==="mouse"||t==="touch")&&this.restartGame()}handleDoubleTap(){this.gameState==="playing"&&this.dashCooldown<=0&&this.dash()}flap(){this.bulletTimeRemaining>0?this.dog.velocity.y=f*1.3:this.dog.velocity.y=f,this.dog.flapAnimation=.3,this.dog.rotation=-30,this.gameMode==="rhythm"&&(this.audioManager.isOnBeat()?(this.perfectBeatStreak++,this.addParticles(this.dog.position,"gold",5),this.score+=1):this.perfectBeatStreak=0),this.superWagMeter=Math.min(100,this.superWagMeter+10),this.settings.screenShake&&!this.settings.motionReduced&&this.addScreenShake(2),this.settings.haptics&&"vibrate"in navigator&&navigator.vibrate(50),this.audioManager.playSound("flap"),this.addParticles(this.dog.position,"white",3)}dash(){this.dog.velocity.x=D,this.dashCooldown=m,this.addParticles(this.dog.position,"blue",8),this.settings.screenShake&&!this.settings.motionReduced&&this.addScreenShake(5),this.settings.haptics&&"vibrate"in navigator&&navigator.vibrate([100,50,100]),this.audioManager.playSound("dash")}_barkPulse(){this.superWagMeter>=100&&(this.bulletTimeRemaining=2e3,this.dog.invulnerable=!0,this.dog.superWagActive=!0,this.superWagMeter=0,this.obstacles.forEach(t=>{if(this.getDistance(this.dog.position,t.position)<150){const i=this.normalize({x:t.position.x-this.dog.position.x,y:t.position.y-this.dog.position.y});t.position.x+=i.x*20,t.position.y+=i.y*10}}),this.collectibles.forEach(t=>{if(t.type==="coin"&&!t.collected&&this.getDistance(this.dog.position,t.position)<100){const i=this.normalize({x:this.dog.position.x-t.position.x,y:this.dog.position.y-t.position.y});t.velocity.x=i.x*5,t.velocity.y=i.y*5}}),this.addParticles(this.dog.position,"yellow",15),this.audioManager.playSound("bark"))}startGame(){var t,e;this.gameState="playing",this.score=0,this.superWagMeter=0,this.dashCooldown=0,this.perfectBeatStreak=0,this.bulletTimeRemaining=0,this.dog=this.createDog(),this.obstacles=[],this.collectibles=[],this.particles=[],this.dailySeed&&(this.recordingGhost=!0,this.ghostData=[]),this.gameMode==="rhythm"?this.audioManager.playMusic("rhythm1"):this.audioManager.playMusic("ambient"),(t=document.getElementById("loading"))==null||t.classList.add("hidden"),this.canvas.classList.remove("hidden"),(e=document.getElementById("uiOverlay"))==null||e.classList.remove("hidden")}pauseGame(){this.gameState==="playing"&&(this.gameState="paused",this.audioManager.pauseMusic())}resumeGame(){this.gameState==="paused"&&(this.gameState="playing",this.audioManager.resumeMusic())}restartGame(){this.gameState="menu",this.audioManager.stopMusic(),this.uiManager.showMenu()}gameOver(){this.gameState="gameover",this.audioManager.stopMusic(),this.audioManager.playSound("gameover"),this.score>this.bestScore&&(this.bestScore=this.score,this.saveSettings(),this.addParticles({x:n/2,y:h/2},"rainbow",20)),this.score<10?this.recentFailures++:this.recentFailures=Math.max(0,this.recentFailures-1),this.updateDifficultyMultiplier(),this.uiManager.showGameOver(this.score,this.bestScore),this.updateQuests()}updateDifficultyMultiplier(){this.recentFailures>=3?this.difficultyMultiplier=Math.max(.7,this.difficultyMultiplier-.1):this.recentFailures===0&&this.score>20&&(this.difficultyMultiplier=Math.min(1.3,this.difficultyMultiplier+.05))}update(t){if(this.gameState!=="playing")return;const e=this.bulletTimeRemaining>0?t*.6:t;this.updateDog(e),this.updateObstacles(e),this.updateCollectibles(e),this.updateParticles(e),this.updateWind(e),this.updateTimers(e),this.checkCollisions(),this.spawnObjects(),this.recordingGhost&&this.ghostData.push({time:Date.now(),position:{...this.dog.position}})}updateDog(t){const e=this.isGliding()?u*F:u;this.dog.velocity.y+=e*(t/16.67),this.wind&&(this.dog.velocity.x+=this.wind.direction.x*this.wind.strength*(t/16.67),this.dog.velocity.y+=this.wind.direction.y*this.wind.strength*(t/16.67)),this.dog.position.x+=this.dog.velocity.x*(t/16.67),this.dog.position.y+=this.dog.velocity.y*(t/16.67),this.dog.velocity.x*=.95,this.dog.rotation=Math.max(-45,Math.min(45,this.dog.velocity.y*2)),this.dog.flapAnimation=Math.max(0,this.dog.flapAnimation-t/1e3),this.dog.blinkTimer+=t,this.dog.blinkTimer>3e3&&(this.dog.blinkTimer=0),this.dog.position.y<0&&(this.dog.position.y=0,this.dog.velocity.y=0),this.dog.position.y>h-this.dog.height&&this.gameOver()}updateObstacles(t){for(let e=this.obstacles.length-1;e>=0;e--){const i=this.obstacles[e];i.position.x-=200*(t/1e3),!i.passed&&i.position.x+i.width<this.dog.position.x&&(i.passed=!0,this.score++,this.audioManager.playSound("score"),this.addParticles({x:i.position.x+i.width,y:i.gapY},"green",3)),i.position.x+i.width<0&&this.obstacles.splice(e,1)}}updateCollectibles(t){for(let e=this.collectibles.length-1;e>=0;e--){const i=this.collectibles[e];i.collected||(i.position.x-=200*(t/1e3),i.position.x+=i.velocity.x*(t/1e3),i.position.y+=i.velocity.y*(t/1e3),i.velocity.x*=.98,i.velocity.y*=.98),i.position.x+i.width<0&&this.collectibles.splice(e,1)}}updateParticles(t){for(let e=this.particles.length-1;e>=0;e--){const i=this.particles[e];i.position.x+=i.velocity.x*(t/1e3),i.position.y+=i.velocity.y*(t/1e3),i.life-=t,i.life<=0&&this.particles.splice(e,1)}}updateWind(t){if(!this.wind||this.wind.elapsed>=this.wind.duration){const e=(Math.random()-.5)*Math.PI;this.wind={strength:y*(.5+Math.random()*.5),direction:{x:Math.cos(e),y:Math.sin(e)*.3},duration:2e3+Math.random()*3e3,elapsed:0}}if(this.wind){this.wind.elapsed+=t;const e=this.wind.elapsed/this.wind.duration,i=Math.sin(e*Math.PI);this.wind.strength=y*i*this.difficultyMultiplier}}updateTimers(t){this.dashCooldown=Math.max(0,this.dashCooldown-t),this.bulletTimeRemaining=Math.max(0,this.bulletTimeRemaining-t),this.bulletTimeRemaining===0&&this.dog.superWagActive&&(this.dog.superWagActive=!1,this.dog.invulnerable=!1)}checkCollisions(){if(!this.dog.invulnerable){for(const t of this.obstacles)if(this.isColliding(this.dog,t)){this.gameOver();return}for(const t of this.collectibles)!t.collected&&this.isColliding(this.dog,t)&&this.collectItem(t)}}collectItem(t){switch(t.collected=!0,t.type){case"bone":this.superWagMeter=Math.min(100,this.superWagMeter+20),this.audioManager.playSound("bone"),this.addParticles(t.position,"bone-white",5);break;case"coin":this.score+=t.value,this.audioManager.playSound("coin"),this.addParticles(t.position,"gold",8);break;case"checkpoint":this.audioManager.playSound("checkpoint"),this.addParticles(t.position,"rainbow",12);break}this.settings.haptics&&"vibrate"in navigator&&navigator.vibrate(100)}spawnObjects(){(this.obstacles.length===0||this.obstacles[this.obstacles.length-1].position.x<n-300)&&this.spawnObstacle(),Math.random()<.02*(this.deltaTime/16.67)&&this.spawnCollectible()}spawnObstacle(){const t=180*this.difficultyMultiplier,e=100+Math.random()*(h-200-t);let i=n+50;if(this.gameMode==="rhythm"){const a=this.audioManager.getNextBeatTime();i=n+a*200}const s={position:{x:i,y:0},velocity:{x:0,y:0},width:80,height:h,active:!0,passed:!1,gapY:e,gapSize:t};this.obstacles.push(s)}spawnCollectible(){const t=Math.random()<.6?"bone":"coin",e=n+100+Math.random()*200,i=50+Math.random()*(h-100);let s=1;t==="coin"&&(s=this.obstacles.some(g=>Math.abs(g.position.x-e)<150&&Math.abs(g.gapY-i)<100)?3:1);const a={position:{x:e,y:i},velocity:{x:0,y:0},width:24,height:24,active:!0,type:t,value:s,collected:!1};this.collectibles.push(a)}render(){this.ctx.fillStyle=this.getBackgroundGradient(),this.ctx.fillRect(0,0,n,h),this.drawParallaxBackground(),this.drawWindParticles(),this.obstacles.forEach(t=>this.drawObstacle(t)),this.collectibles.forEach(t=>{t.collected||this.drawCollectible(t)}),this.particles.forEach(t=>this.drawParticle(t)),this.drawDog(),this.drawUI()}getBackgroundGradient(){const t=this.ctx.createLinearGradient(0,0,0,h);return this.settings.highContrast?(t.addColorStop(0,"#000000"),t.addColorStop(1,"#333333")):this.settings.colorblind?(t.addColorStop(0,"#4A90E2"),t.addColorStop(1,"#2C5282")):(t.addColorStop(0,"#87CEEB"),t.addColorStop(1,"#4682B4")),t}drawParallaxBackground(){if(this.settings.motionReduced)return;const t=Date.now()*.02%n;this.ctx.fillStyle="rgba(255, 255, 255, 0.3)";for(let e=0;e<5;e++){const i=(e*200-t)%(n+100),s=50+e*30%150;this.drawCloud(i,s,60+e*10)}}drawCloud(t,e,i){this.ctx.save(),this.ctx.globalAlpha=.6,this.ctx.fillStyle="#FFFFFF",this.ctx.beginPath(),this.ctx.arc(t,e,i*.5,0,Math.PI*2),this.ctx.arc(t+i*.3,e,i*.4,0,Math.PI*2),this.ctx.arc(t-i*.3,e,i*.4,0,Math.PI*2),this.ctx.fill(),this.ctx.restore()}drawWindParticles(){if(!(!this.wind||this.settings.motionReduced)){this.ctx.save(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.3)",this.ctx.lineWidth=2;for(let t=0;t<10;t++){const e=(t*80+Date.now()*.1)%n,i=100+t*50%(h-200);this.ctx.beginPath(),this.ctx.moveTo(e,i),this.ctx.lineTo(e+this.wind.direction.x*20,i+this.wind.direction.y*20),this.ctx.stroke()}this.ctx.restore()}}drawObstacle(t){this.ctx.save(),this.ctx.fillStyle=this.settings.colorblind?"#FF6B6B":"#90EE90",this.ctx.strokeStyle="#228B22",this.ctx.lineWidth=3,this.drawRoundedRect(t.position.x,0,t.width,t.gapY,10),this.drawRoundedRect(t.position.x,t.gapY+t.gapSize,t.width,h-(t.gapY+t.gapSize),10),this.ctx.restore()}drawCollectible(t){this.ctx.save();const e=t.position.x+t.width/2,i=t.position.y+t.height/2,s=Math.sin(Date.now()*.005+e*.01)*3;if(this.ctx.translate(e,i+s),t.type==="bone")this.ctx.fillStyle="#FFF8DC",this.ctx.strokeStyle="#DDD",this.drawBone();else if(t.type==="coin"){const a=t.value>1;this.ctx.fillStyle=a?"#FFD700":"#FFA500",this.ctx.strokeStyle=a?"#B8860B":"#FF8C00",this.drawCoin(a)}this.ctx.restore()}drawBone(){this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.ellipse(-8,0,4,8,0,0,Math.PI*2),this.ctx.ellipse(8,0,4,8,0,0,Math.PI*2),this.ctx.rect(-8,-2,16,4),this.ctx.fill(),this.ctx.stroke()}drawCoin(t){if(this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(0,0,t?12:10,0,Math.PI*2),this.ctx.fill(),this.ctx.stroke(),this.ctx.fillStyle="rgba(255, 255, 255, 0.6)",this.ctx.beginPath(),this.ctx.arc(-3,-3,3,0,Math.PI*2),this.ctx.fill(),t){this.ctx.fillStyle="#FFFFFF";for(let e=0;e<4;e++){const i=e/4*Math.PI*2+Date.now()*.01,s=Math.cos(i)*15,a=Math.sin(i)*15;this.ctx.fillRect(s-1,a-1,2,2)}}}drawDog(){this.ctx.save();const t=this.dog.position.x+this.dog.width/2,e=this.dog.position.y+this.dog.height/2;this.ctx.translate(t,e),this.ctx.rotate(this.dog.rotation*Math.PI/180);const i=1-this.dog.flapAnimation*.3;this.ctx.scale(1,i),this.dog.superWagActive&&(this.ctx.shadowColor="#FFD700",this.ctx.shadowBlur=20),this.dog.invulnerable&&(this.ctx.globalAlpha=.5+Math.sin(Date.now()*.02)*.3);const s=this.sprites.get("dog");if(s){const a=Math.floor(this.dog.flapAnimation*3)%3;this.ctx.drawImage(s,a*48,0,48,32,-this.dog.width/2,-this.dog.height/2,this.dog.width,this.dog.height)}else this.drawFallbackDog();this.ctx.restore()}drawFallbackDog(){this.ctx.fillStyle="#D2B48C",this.ctx.fillRect(-24,-16,48,32),this.ctx.fillStyle="#FFFFFF",this.ctx.fillRect(8,-8,8,8),this.ctx.fillStyle="#000000";const e=4*(1-Math.max(0,1-Math.abs(this.dog.blinkTimer-150)/50));this.ctx.fillRect(10,-6,4,e),this.ctx.fillStyle="#000000",this.ctx.fillRect(20,-2,4,4),this.ctx.fillStyle="#A0522D",this.ctx.fillRect(-20,-12,12,8)}drawParticle(t){this.ctx.save();const e=t.life/t.maxLife;if(this.ctx.globalAlpha=e,t.color==="rainbow"){const i=(Date.now()*.5+t.position.x)%360;this.ctx.fillStyle=`hsl(${i}, 100%, 50%)`}else this.ctx.fillStyle=t.color;this.ctx.beginPath(),this.ctx.arc(t.position.x,t.position.y,t.size,0,Math.PI*2),this.ctx.fill(),this.ctx.restore()}drawUI(){this.ctx.save(),this.ctx.font="24px monospace",this.ctx.fillStyle=this.settings.highContrast?"#FFFFFF":"#000000",this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=3;const t=`Score: ${this.score}`;if(this.ctx.strokeText(t,20,40),this.ctx.fillText(t,20,40),this.bestScore>0){const e=`Best: ${this.bestScore}`;this.ctx.strokeText(e,20,70),this.ctx.fillText(e,20,70)}this.drawSuperWagMeter(),this.dashCooldown>0&&this.drawDashCooldown(),this.gameMode==="rhythm"&&this.perfectBeatStreak>0&&this.drawBeatStreak(),this.bulletTimeRemaining>0&&this.drawBulletTimeIndicator(),this.ctx.restore()}drawSuperWagMeter(){const t=n-120,e=30,i=100,s=10;this.ctx.fillStyle="rgba(0, 0, 0, 0.3)",this.ctx.fillRect(t,e,i,s);const a=this.superWagMeter/100*i;this.ctx.fillStyle=this.superWagMeter>=100?"#FFD700":"#FFA500",this.ctx.fillRect(t,e,a,s),this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=2,this.ctx.strokeRect(t,e,i,s),this.ctx.font="12px monospace",this.ctx.fillStyle="#FFFFFF",this.ctx.fillText("SUPER WAG",t,e-5)}drawDashCooldown(){const t=n-120,e=60,i=1-this.dashCooldown/m;this.ctx.fillStyle="rgba(0, 0, 255, 0.7)",this.ctx.beginPath(),this.ctx.arc(t+50,e,15,-Math.PI/2,-Math.PI/2+i*Math.PI*2),this.ctx.lineTo(t+50,e),this.ctx.fill(),this.ctx.font="10px monospace",this.ctx.fillStyle="#FFFFFF",this.ctx.textAlign="center",this.ctx.fillText("DASH",t+50,e+25),this.ctx.textAlign="left"}drawBeatStreak(){this.ctx.font="18px monospace",this.ctx.fillStyle="#FFD700",this.ctx.strokeStyle="#B8860B",this.ctx.lineWidth=2;const t=`♪ ${this.perfectBeatStreak} STREAK ♪`,e=n/2-this.ctx.measureText(t).width/2;this.ctx.strokeText(t,e,100),this.ctx.fillText(t,e,100)}drawBulletTimeIndicator(){const t=this.bulletTimeRemaining/2e3;this.ctx.fillStyle=`rgba(255, 215, 0, ${.1*t})`,this.ctx.fillRect(0,0,n,h);const e=50,i=h-50,s=n-100,a=8;this.ctx.fillStyle="rgba(0, 0, 0, 0.5)",this.ctx.fillRect(e,i,s,a),this.ctx.fillStyle="#FFD700",this.ctx.fillRect(e,i,s*t,a),this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=2,this.ctx.strokeRect(e,i,s,a),this.ctx.font="14px monospace",this.ctx.fillStyle="#FFD700",this.ctx.fillText("BULLET TIME",e,i-10)}drawDebugInfo(){this.ctx.font="12px monospace",this.ctx.fillStyle="#00FF00",[`FPS: ${this.fps}`,`Difficulty: ${this.difficultyMultiplier.toFixed(2)}`,`Wind: ${this.wind?this.wind.strength.toFixed(2):"None"}`,`Objects: ${this.obstacles.length+this.collectibles.length}`,`Particles: ${this.particles.length}`].forEach((e,i)=>{this.ctx.fillText(e,20,h-100+i*15)})}drawRoundedRect(t,e,i,s,a){this.ctx.beginPath(),this.ctx.moveTo(t+a,e),this.ctx.lineTo(t+i-a,e),this.ctx.quadraticCurveTo(t+i,e,t+i,e+a),this.ctx.lineTo(t+i,e+s-a),this.ctx.quadraticCurveTo(t+i,e+s,t+i-a,e+s),this.ctx.lineTo(t+a,e+s),this.ctx.quadraticCurveTo(t,e+s,t,e+s-a),this.ctx.lineTo(t,e+a),this.ctx.quadraticCurveTo(t,e,t+a,e),this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke()}isGliding(){return this.keys.has("Space")||this.mousePressed||this.touchPressed}isColliding(t,e){return t.position.x+2<e.position.x+e.width&&t.position.x+t.width-2>e.position.x&&t.position.y+2<e.position.y+e.height&&t.position.y+t.height-2>e.position.y}getDistance(t,e){const i=t.x-e.x,s=t.y-e.y;return Math.sqrt(i*i+s*s)}normalize(t){const e=Math.sqrt(t.x*t.x+t.y*t.y);return e===0?{x:0,y:0}:{x:t.x/e,y:t.y/e}}addParticles(t,e,i){for(let s=0;s<i;s++){const a=Math.random()*Math.PI*2,r=50+Math.random()*100;this.particles.push({position:{...t},velocity:{x:Math.cos(a)*r,y:Math.sin(a)*r},life:500+Math.random()*1e3,maxLife:1500,color:e,size:2+Math.random()*3})}}addScreenShake(t){if(!this.settings.screenShake||this.settings.motionReduced)return;const e=(Math.random()-.5)*t,i=(Math.random()-.5)*t;this.ctx.save(),this.ctx.translate(e,i),setTimeout(()=>{this.ctx.restore()},100)}generateDailySeed(){const t=new Date;this.dailySeed=`${t.getFullYear()}${(t.getMonth()+1).toString().padStart(2,"0")}${t.getDate().toString().padStart(2,"0")}`}initializeQuests(){this._activeQuests=[{id:"flap_master",description:"Pass 10 gates without gliding",progress:0,target:10,completed:!1,reward:"Golden Collar"},{id:"coin_collector",description:"Collect 5 coins in one run",progress:0,target:5,completed:!1,reward:"Sparkle Trail"},{id:"rhythm_master",description:"Get 15 perfect beats in rhythm mode",progress:0,target:15,completed:!1,reward:"Beat Wings"}]}updateQuests(){}loadAssets(){const t=["dog.png","obstacles.png","bones.png","coins.png","clouds.png"];this.totalSprites=t.length,t.forEach(e=>{const i=new Image;i.onload=()=>{this.sprites.set(e.split(".")[0],i),this.spritesLoaded++,this.spritesLoaded===this.totalSprites&&this.onAssetsLoaded()},i.onerror=()=>{console.warn(`Failed to load asset: ${e}`),this.spritesLoaded++,this.spritesLoaded===this.totalSprites&&this.onAssetsLoaded()},i.src=`/assets/${e}`})}onAssetsLoaded(){this.audioManager.initialize(),this.uiManager.initialize(this.canvas),this.leaderboardManager.initialize(),this.uiManager.showMenu(),this.gameLoop()}loadSettings(){const t=localStorage.getItem("flappydog-settings");t&&(this.settings={...this.settings,...JSON.parse(t)});const e=localStorage.getItem("flappydog-bestscore");e&&(this.bestScore=parseInt(e,10))}saveSettings(){localStorage.setItem("flappydog-settings",JSON.stringify(this.settings)),localStorage.setItem("flappydog-bestscore",this.bestScore.toString())}setGameMode(t){this.gameMode=t}updateSettings(t){this.settings={...this.settings,...t},this.saveSettings()}getSettings(){return{...this.settings}}getDailyScore(){return{score:this.score,seed:this.dailySeed}}uploadCustomSprite(t){const e=new FileReader;e.onload=i=>{var a;const s=new Image;s.onload=()=>{this.sprites.set("dog",s)},s.src=(a=i.target)==null?void 0:a.result},e.readAsDataURL(t)}}document.addEventListener("DOMContentLoaded",()=>{new P});"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").then(d=>{console.log("SW registered: ",d)}).catch(d=>{console.log("SW registration failed: ",d)})});
