class u{constructor(){this.audioContext=null,this.masterGainNode=null,this.sfxGainNode=null,this.musicGainNode=null,this.sounds=new Map,this.music=new Map,this.currentTrack=null,this.settings={soundVolume:.7,musicVolume:.5,haptics:!0},this.beatDetectionEnabled=!1,this._lastBeatTime=0,this.beatTolerance=150,this._metronomeEnabled=!0,this.visualMetronome=!0,this.loadedAssets=0,this.totalAssets=0,this.loadingPromises=[],this.supportsWebAudio=!1,this._supportsAudioWorklet=!1,this.detectAudioSupport()}async initialize(){try{await this.initializeAudioContext(),await this.loadAllAudio(),this.setupGainNodes(),console.log("Audio system initialized successfully")}catch(e){console.warn("Audio initialization failed:",e),this.fallbackToHTMLAudio()}}detectAudioSupport(){this.supportsWebAudio=!!(window.AudioContext||window.webkitAudioContext),this._supportsAudioWorklet=this.supportsWebAudio&&"audioWorklet"in AudioContext.prototype}async initializeAudioContext(){if(!this.supportsWebAudio)throw new Error("Web Audio API not supported");const e=window.AudioContext||window.webkitAudioContext;this.audioContext=new e,this.audioContext.state==="suspended"&&this.setupUserInteractionUnlock()}setupUserInteractionUnlock(){const e=()=>{var t;((t=this.audioContext)==null?void 0:t.state)==="suspended"&&this.audioContext.resume().then(()=>{console.log("Audio context resumed")}),document.removeEventListener("touchstart",e),document.removeEventListener("touchend",e),document.removeEventListener("mousedown",e),document.removeEventListener("keydown",e)};document.addEventListener("touchstart",e),document.addEventListener("touchend",e),document.addEventListener("mousedown",e),document.addEventListener("keydown",e)}setupGainNodes(){this.audioContext&&(this.masterGainNode=this.audioContext.createGain(),this.masterGainNode.connect(this.audioContext.destination),this.sfxGainNode=this.audioContext.createGain(),this.sfxGainNode.connect(this.masterGainNode),this.sfxGainNode.gain.value=this.settings.soundVolume,this.musicGainNode=this.audioContext.createGain(),this.musicGainNode.connect(this.masterGainNode),this.musicGainNode.gain.value=this.settings.musicVolume)}async loadAllAudio(){const e=[{name:"flap",path:"/assets/ui_sfx/flap.mp3",type:"sfx",volume:.6},{name:"coin",path:"/assets/ui_sfx/coin.mp3",type:"sfx",volume:.7},{name:"bone",path:"/assets/ui_sfx/bone.mp3",type:"sfx",volume:.5},{name:"checkpoint",path:"/assets/ui_sfx/checkpoint.mp3",type:"sfx",volume:.8},{name:"bark",path:"/assets/ui_sfx/bark.mp3",type:"sfx",volume:.9},{name:"dash",path:"/assets/ui_sfx/dash.mp3",type:"sfx",volume:.7},{name:"score",path:"/assets/ui_sfx/score.mp3",type:"sfx",volume:.5},{name:"gameover",path:"/assets/ui_sfx/gameover.mp3",type:"sfx",volume:.8},{name:"button",path:"/assets/ui_sfx/button.mp3",type:"sfx",volume:.4},{name:"quest_complete",path:"/assets/ui_sfx/quest_complete.mp3",type:"sfx",volume:.9},{name:"rhythm1",path:"/assets/music/rhythm1.mp3",type:"music",bpm:120,volume:.6},{name:"rhythm2",path:"/assets/music/rhythm2.mp3",type:"music",bpm:90,volume:.6},{name:"ambient",path:"/assets/music/ambient.mp3",type:"music",bpm:0,volume:.4},{name:"menu",path:"/assets/music/menu.mp3",type:"music",bpm:0,volume:.3}];this.totalAssets=e.length,this.loadingPromises=e.map(t=>this.loadAudioAsset(t));try{await Promise.all(this.loadingPromises),console.log("All audio assets loaded successfully")}catch(t){console.warn("Some audio assets failed to load:",t)}}async loadAudioAsset(e){try{const t=await fetch(e.path);if(!t.ok)throw new Error(`Failed to fetch ${e.path}: ${t.status}`);const s=await t.arrayBuffer();if(this.audioContext){const i=await this.audioContext.decodeAudioData(s);if(e.type==="sfx")this.sounds.set(e.name,{name:e.name,buffer:i,sources:[],volume:e.volume||1,loop:!1});else if(e.type==="music"){const n={name:e.name,buffer:i,source:null,gainNode:null,bpm:e.bpm||0,beatTimes:[],startTime:0,volume:e.volume||1,loop:!0};e.bpm>0&&(n.beatTimes=this.generateBeatTimes(i.duration,e.bpm)),this.music.set(e.name,n)}}this.loadedAssets++}catch(t){console.warn(`Failed to load audio asset ${e.name}:`,t),this.loadedAssets++,e.type==="sfx"?this.sounds.set(e.name,{name:e.name,buffer:null,sources:[],volume:e.volume||1,loop:!1}):e.type==="music"&&this.music.set(e.name,{name:e.name,buffer:null,source:null,gainNode:null,bpm:e.bpm||0,beatTimes:[],startTime:0,volume:e.volume||1,loop:!0})}}generateBeatTimes(e,t){const s=60/t,i=[];for(let n=0;n<e;n+=s)i.push(n);return i}fallbackToHTMLAudio(){console.log("Falling back to HTML Audio API")}playSound(e,t=1,s=1){if(!this.audioContext||!this.sfxGainNode){this.playHTMLAudio(e,t);return}const i=this.sounds.get(e);if(!i||!i.buffer){console.warn(`Sound not found: ${e}`);return}try{const n=this.audioContext.createBufferSource();n.buffer=i.buffer;const o=this.audioContext.createGain();o.gain.value=i.volume*t*this.settings.soundVolume,s!==1&&(n.playbackRate.value=s),n.connect(o),o.connect(this.sfxGainNode),n.start(0),n.onended=()=>{n.disconnect(),o.disconnect();const a=i.sources.indexOf(n);a>-1&&i.sources.splice(a,1)},i.sources.push(n)}catch(n){console.warn(`Failed to play sound ${e}:`,n)}}playHTMLAudio(e,t){const s=new Audio(`/assets/ui_sfx/${e}.mp3`);s.volume=t*this.settings.soundVolume,s.play().catch(i=>{console.warn(`Failed to play HTML audio ${e}:`,i)})}playMusic(e,t=!0){if(!this.audioContext||!this.musicGainNode)return;this.stopMusic();const s=this.music.get(e);if(!s||!s.buffer){console.warn(`Music track not found: ${e}`);return}try{s.source=this.audioContext.createBufferSource(),s.source.buffer=s.buffer,s.source.loop=s.loop,s.gainNode=this.audioContext.createGain(),s.gainNode.gain.value=t?0:s.volume*this.settings.musicVolume,s.source.connect(s.gainNode),s.gainNode.connect(this.musicGainNode),s.source.start(0),s.startTime=this.audioContext.currentTime,t&&s.gainNode.gain.linearRampToValueAtTime(s.volume*this.settings.musicVolume,this.audioContext.currentTime+1),this.currentTrack=s,s.bpm>0&&(this.beatDetectionEnabled=!0)}catch(i){console.warn(`Failed to play music ${e}:`,i)}}stopMusic(e=!0){if(!(!this.currentTrack||!this.currentTrack.source))try{e&&this.currentTrack.gainNode&&this.audioContext?(this.currentTrack.gainNode.gain.linearRampToValueAtTime(0,this.audioContext.currentTime+.5),setTimeout(()=>{var t;(t=this.currentTrack)!=null&&t.source&&(this.currentTrack.source.stop(),this.currentTrack.source=null,this.currentTrack.gainNode=null)},500)):(this.currentTrack.source.stop(),this.currentTrack.source=null,this.currentTrack.gainNode=null),this.beatDetectionEnabled=!1,this.currentTrack=null}catch(t){console.warn("Failed to stop music:",t)}}pauseMusic(){var e;(e=this.currentTrack)!=null&&e.gainNode&&this.audioContext&&this.currentTrack.gainNode.gain.linearRampToValueAtTime(0,this.audioContext.currentTime+.1)}resumeMusic(){var e;(e=this.currentTrack)!=null&&e.gainNode&&this.audioContext&&this.currentTrack.gainNode.gain.linearRampToValueAtTime(this.currentTrack.volume*this.settings.musicVolume,this.audioContext.currentTime+.1)}isOnBeat(e=this.beatTolerance){if(!this.beatDetectionEnabled||!this.currentTrack||!this.audioContext)return!1;const t=this.getCurrentMusicTime(),s=this.getNearestBeatTime(t);return s===null?!1:Math.abs(t-s)*1e3<=e}getBeatAccuracy(){if(!this.beatDetectionEnabled||!this.currentTrack||!this.audioContext)return 0;const e=this.getCurrentMusicTime(),t=this.getNearestBeatTime(e);if(t===null)return 0;const s=Math.abs(e-t)*1e3;return Math.max(0,1-s/this.beatTolerance)}getNextBeatTime(){if(!this.currentTrack||!this.audioContext)return 0;const e=this.getCurrentMusicTime(),t=this.currentTrack.beatTimes.find(s=>s>e);return t?t-e:0}getCurrentBeatInfo(){if(!this.beatDetectionEnabled||!this.currentTrack)return null;const e=this.getCurrentMusicTime(),t=this.getNearestBeatTime(e);if(t===null)return null;const i=this.currentTrack.beatTimes.indexOf(t)%4===0,n=Math.abs(e-t)*1e3,o=Math.max(0,1-n/this.beatTolerance);return{time:t,intensity:o,isDownbeat:i}}getCurrentMusicTime(){return!this.currentTrack||!this.audioContext?0:this.audioContext.currentTime-this.currentTrack.startTime}getNearestBeatTime(e){if(!this.currentTrack||this.currentTrack.beatTimes.length===0)return null;let t=this.currentTrack.beatTimes[0],s=Math.abs(e-t);for(const i of this.currentTrack.beatTimes){const n=Math.abs(e-i);n<s&&(s=n,t=i)}return t}enableMetronome(e=!0,t=!0){this._metronomeEnabled=t,this.visualMetronome=e}disableMetronome(){this._metronomeEnabled=!1,this.visualMetronome=!1}getVisualMetronomeState(){if(!this.visualMetronome)return{active:!1,intensity:0,isDownbeat:!1};const e=this.getCurrentBeatInfo();return e?{active:!0,intensity:e.intensity,isDownbeat:e.isDownbeat}:{active:!1,intensity:0,isDownbeat:!1}}getAudioSpectrum(){return null}getVolumeLevel(){return 0}updateSettings(e){var t,s;this.settings={...this.settings,...e},this.sfxGainNode&&this.sfxGainNode.gain.linearRampToValueAtTime(this.settings.soundVolume,((t=this.audioContext)==null?void 0:t.currentTime)||0+.1),this.musicGainNode&&this.currentTrack&&this.musicGainNode.gain.linearRampToValueAtTime(this.settings.musicVolume,((s=this.audioContext)==null?void 0:s.currentTime)||0+.1)}getSettings(){return{...this.settings}}isLoaded(){return this.loadedAssets===this.totalAssets}getLoadingProgress(){return this.totalAssets>0?this.loadedAssets/this.totalAssets:1}isPlaying(e){var t,s,i;return e?((t=this.currentTrack)==null?void 0:t.name)===e&&((s=this.currentTrack)==null?void 0:s.source)!==null:((i=this.currentTrack)==null?void 0:i.source)!==null}getCurrentTrackName(){var e;return((e=this.currentTrack)==null?void 0:e.name)||null}playPositionalSound(e,t,s,i=1e3){const n=Math.sqrt(t*t+s*s),o=Math.max(0,1-n/i);this.playSound(e,o)}addReverb(e=.3){this.audioContext}addFilter(e,t="lowpass"){this.audioContext}dispose(){this.stopMusic(!1);for(const e of this.sounds.values())e.sources.forEach(t=>{try{t.stop()}catch(s){}}),e.sources=[];this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.sounds.clear(),this.music.clear(),this.currentTrack=null}}export{u as A};
